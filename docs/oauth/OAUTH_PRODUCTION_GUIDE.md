# OAuth Production Release Guide

## Overview
This document outlines everything needed to deploy QuestLog's OAuth system to production, including URL configurations, environment variables, and release day checklist.

## Current OAuth Implementation

### Mobile OAuth Architecture
- **Implementation**: WebBrowser.openAuthSessionAsync() with manual session creation
- **Packages**: expo-auth-session, expo-web-browser
- **Flow**: OAuth session ‚Üí Google auth ‚Üí callback URL ‚Üí manual session creation
- **Session Management**: QueryParams parsing + supabase.auth.setSession()

### Key Files
- `AuthService.ts`: Mobile OAuth implementation with WebBrowser.openAuthSessionAsync
- `AuthContext.tsx`: Global authentication state management  
- `LoginScreen.tsx`: OAuth button with clean error handling
- `supabase.ts`: Supabase client configuration

## Production Environment Setup

### 1. Google Console Configuration

#### Development URLs (Current)
```
Authorized JavaScript origins:
- http://localhost:8081 (for web testing)
- https://your-tunnel-url.exp.direct (Expo tunnel)

Authorized redirect URIs:
- http://localhost:8081/auth/callback
- https://your-tunnel-url.exp.direct/auth/callback
```

#### Production URLs (Required for App Store)
```
Authorized JavaScript origins:
- https://your-domain.com (your web domain if applicable)
- https://yourapplication.supabase.co (Supabase project URL)

Authorized redirect URIs:
- questlog://auth/callback (mobile deep link)
- https://yourapplication.supabase.co/auth/v1/callback (Supabase OAuth)
- https://your-domain.com/auth/callback (web if applicable)
```

### 2. Supabase Configuration

#### Authentication Settings
```
Site URL: https://your-domain.com (or your main domain)
Redirect URLs: 
- questlog://auth/callback
- https://your-domain.com/auth/callback
```

#### Google OAuth Provider
```
Client ID: Your Google OAuth Client ID
Client Secret: Your Google OAuth Client Secret
Redirect URL: Automatically handled by Supabase
```

### 3. App Store Configuration

#### iOS (app.json / app.config.js)
```json
{
  "expo": {
    "scheme": "questlog",
    "ios": {
      "bundleIdentifier": "com.yourcompany.questlog"
    }
  }
}
```

#### Android (app.json / app.config.js)  
```json
{
  "expo": {
    "scheme": "questlog",
    "android": {
      "package": "com.yourcompany.questlog"
    }
  }
}
```

## Environment Variables

### Required for Production
```bash
# Supabase Configuration
EXPO_PUBLIC_SUPABASE_URL=https://yourapplication.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# App Configuration
EXPO_PUBLIC_APP_NAME=QuestLog
EXPO_PUBLIC_APP_VERSION=1.0.0

# OAuth Redirect (automatically generated by expo-auth-session)
# No manual configuration needed for mobile OAuth
```

### Development vs Production
| Variable | Development | Production |
|----------|-------------|------------|
| SUPABASE_URL | Development project | Production project |
| SUPABASE_ANON_KEY | Development key | Production key |
| Google Client ID | Development ID | Production ID |
| Redirect URLs | localhost + tunnel | Production domains + deep links |

## OAuth Flow Details

### Mobile OAuth Process
1. User clicks "Sign in with Google"
2. `makeRedirectUri()` generates proper redirect URL for current platform
3. Supabase creates OAuth URL with redirect parameter
4. `WebBrowser.openAuthSessionAsync()` opens OAuth session
5. User authenticates with Google in OAuth browser
6. Google redirects to Supabase OAuth endpoint
7. Supabase processes OAuth and redirects to app with tokens
8. WebBrowser detects redirect and returns to app with callback URL
9. App parses tokens using `QueryParams.getQueryParams()`
10. App creates session using `supabase.auth.setSession()`
11. AuthContext detects session change and updates app state

### Critical Implementation Details
- **No Deep Links**: The new implementation doesn't require manual deep link handling
- **Automatic Redirect**: expo-auth-session handles platform-specific redirects automatically
- **Session Creation**: Manual session creation ensures tokens are properly stored
- **Error Handling**: Clean error states without false failure popups

## Release Day Checklist

### Pre-Release (Development Complete)
- [x] Mobile OAuth implementation tested and working
- [x] WebBrowser.openAuthSessionAsync properly implemented
- [x] Manual session creation with QueryParams working
- [x] Error handling cleaned up (no false failure popups)
- [x] Package dependencies added (expo-auth-session, expo-web-browser)

### App Store Preparation
- [ ] Update Google Console with production redirect URLs
- [ ] Configure Supabase authentication settings for production
- [ ] Update app.json with final bundle identifiers and scheme
- [ ] Test OAuth on production Supabase environment
- [ ] Verify deep link handling works with production URLs

### Environment Configuration
- [ ] Create production Supabase project (if separate from development)
- [ ] Configure production Google OAuth client
- [ ] Set up production environment variables
- [ ] Update redirect URLs in all OAuth providers
- [ ] Test OAuth flow end-to-end on production environment

### App Store Deployment
- [ ] Build production app with EAS Build
- [ ] Test OAuth on physical devices with production build
- [ ] Submit to app stores with OAuth configuration
- [ ] Monitor OAuth success rates post-launch
- [ ] Set up error tracking for OAuth failures

### Post-Launch Monitoring
- [ ] Monitor OAuth authentication success rates
- [ ] Track authentication errors and failure patterns
- [ ] Verify deep link handling works on all devices
- [ ] Monitor Supabase authentication logs
- [ ] Set up alerts for OAuth failure spikes

## Common Production Issues & Solutions

### Issue: OAuth Stuck on Loading
**Cause**: Incorrect redirect URLs in Google Console or Supabase
**Solution**: Verify all redirect URLs match exactly, including scheme

### Issue: Deep Link Not Working
**Cause**: App scheme not properly configured or registered
**Solution**: Verify scheme in app.json and test with `npx uri-scheme list`

### Issue: Session Not Created After OAuth
**Cause**: QueryParams parsing failing or session creation error
**Solution**: Check logs for token parsing errors, verify supabase.auth.setSession call

### Issue: False Authentication Errors
**Cause**: Error handling checking wrong response format
**Solution**: Verify OAuth response parsing matches new implementation format

## Testing Checklist

### Development Testing
- [x] OAuth works on Expo Go mobile
- [x] OAuth works on web localhost
- [x] Error states display correctly
- [x] Session persists after OAuth completion
- [x] User can sign out and sign back in

### Production Testing (Required)
- [ ] OAuth works on production builds (iOS/Android)
- [ ] Deep links work from external browsers
- [ ] Session persistence works across app restarts
- [ ] Error handling works with production OAuth URLs
- [ ] Performance acceptable on slower devices/networks

## Support & Debugging

### OAuth Logs to Monitor
```javascript
// Key log messages for debugging OAuth issues
console.log('üìù Redirect URI:', redirectTo); // Verify correct redirect URL
console.log('‚úÖ Mobile OAuth URL generated:', data.url); // Verify OAuth URL creation
console.log('üåê WebBrowser result:', result); // Verify OAuth session completion
console.log('‚úÖ OAuth completed, processing session...'); // Verify token processing
console.log('üéâ Mobile OAuth successful!'); // Verify session creation
```

### Common Debug Commands
```bash
# Test deep link handling
npx uri-scheme open questlog://auth/callback --ios
npx uri-scheme open questlog://auth/callback --android

# Check app scheme registration
npx uri-scheme list

# Verify OAuth redirect generation
# (Check logs for makeRedirectUri() output)
```

## Security Considerations

### Production Security
- Store sensitive keys in secure environment variables
- Use production-grade Supabase instance with proper RLS
- Validate OAuth tokens on server side
- Implement rate limiting for authentication attempts
- Monitor for suspicious OAuth patterns

### OAuth Best Practices
- Use HTTPS for all production redirect URLs
- Implement proper session timeout handling
- Store minimal user data from OAuth providers
- Regularly rotate OAuth client secrets
- Monitor OAuth provider security advisories

---

*This documentation should be updated as OAuth requirements change or new providers are added.*